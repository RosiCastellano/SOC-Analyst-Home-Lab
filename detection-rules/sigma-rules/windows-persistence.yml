title: Registry Run Key Persistence
id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
status: stable
description: Detects modification of registry Run keys for persistence
references:
    - https://attack.mitre.org/techniques/T1547/001/
    - https://github.com/RosiCastellano/SOC-Analyst-Home-Lab
author: SOC Analyst Home Lab
date: 2024/01/01
tags:
    - attack.persistence
    - attack.t1547.001
logsource:
    category: registry_set
    product: windows
detection:
    selection:
        TargetObject|contains:
            - '\CurrentVersion\Run'
            - '\CurrentVersion\RunOnce'
            - '\CurrentVersion\RunServices'
            - '\CurrentVersion\RunServicesOnce'
            - '\CurrentVersion\Policies\Explorer\Run'
    filter:
        Image|contains:
            - '\msiexec.exe'
            - '\software distribution\'
    condition: selection and not filter
falsepositives:
    - Legitimate software installations
    - Windows updates
level: high

---

title: Scheduled Task Creation via Command Line
id: b2c3d4e5-f6a7-8901-bcde-f23456789012
status: stable
description: Detects scheduled task creation via schtasks.exe
references:
    - https://attack.mitre.org/techniques/T1053/005/
author: SOC Analyst Home Lab
date: 2024/01/01
tags:
    - attack.persistence
    - attack.execution
    - attack.t1053.005
logsource:
    category: process_creation
    product: windows
detection:
    selection:
        Image|endswith: '\schtasks.exe'
        CommandLine|contains|all:
            - '/create'
    condition: selection
falsepositives:
    - Legitimate administrative tasks
    - Software installers
level: medium

---

title: Suspicious Scheduled Task Created
id: c3d4e5f6-a7b8-9012-cdef-345678901234
status: stable
description: Detects suspicious scheduled task creation patterns
references:
    - https://attack.mitre.org/techniques/T1053/005/
author: SOC Analyst Home Lab
date: 2024/01/01
tags:
    - attack.persistence
    - attack.t1053.005
logsource:
    category: process_creation
    product: windows
detection:
    selection:
        Image|endswith: '\schtasks.exe'
        CommandLine|contains:
            - '/create'
    suspicious_exec:
        CommandLine|contains:
            - 'powershell'
            - 'cmd /c'
            - 'wscript'
            - 'cscript'
            - 'mshta'
            - '.vbs'
            - '.ps1'
            - '.bat'
    suspicious_path:
        CommandLine|contains:
            - '\Temp\'
            - '\AppData\'
            - '\Downloads\'
            - '\Users\Public\'
    condition: selection and (suspicious_exec or suspicious_path)
falsepositives:
    - Some legitimate software
level: high

---

title: New Windows Service Creation
id: d4e5f6a7-b8c9-0123-def0-456789012345
status: stable
description: Detects creation of new Windows services
references:
    - https://attack.mitre.org/techniques/T1543/003/
author: SOC Analyst Home Lab
date: 2024/01/01
tags:
    - attack.persistence
    - attack.t1543.003
logsource:
    product: windows
    service: system
detection:
    selection:
        EventID: 7045
    filter:
        ServiceName|contains:
            - 'Windows Update'
            - 'Microsoft'
    condition: selection and not filter
falsepositives:
    - Legitimate software installation
level: medium

---

title: Service Installed in Suspicious Location
id: e5f6a7b8-c9d0-1234-ef01-567890123456
status: stable
description: Detects service installation with executable in suspicious location
references:
    - https://attack.mitre.org/techniques/T1543/003/
author: SOC Analyst Home Lab
date: 2024/01/01
tags:
    - attack.persistence
    - attack.t1543.003
logsource:
    product: windows
    service: system
detection:
    selection:
        EventID: 7045
    suspicious_path:
        ImagePath|contains:
            - '\Temp\'
            - '\AppData\'
            - '\Downloads\'
            - '\Users\Public\'
            - '\ProgramData\'
    condition: selection and suspicious_path
falsepositives:
    - Some legitimate software
level: high

---

title: WMI Event Subscription Persistence
id: f6a7b8c9-d0e1-2345-f012-678901234567
status: stable
description: Detects WMI event subscription creation for persistence
references:
    - https://attack.mitre.org/techniques/T1546/003/
author: SOC Analyst Home Lab
date: 2024/01/01
tags:
    - attack.persistence
    - attack.t1546.003
logsource:
    category: wmi_event
    product: windows
detection:
    selection:
        EventType: 'WmiEventConsumerToFilter'
    condition: selection
falsepositives:
    - Legitimate WMI subscriptions
level: high

---

title: Startup Folder Persistence
id: a7b8c9d0-e1f2-3456-0123-789012345678
status: stable
description: Detects file creation in Startup folder for persistence
references:
    - https://attack.mitre.org/techniques/T1547/001/
author: SOC Analyst Home Lab
date: 2024/01/01
tags:
    - attack.persistence
    - attack.t1547.001
logsource:
    category: file_event
    product: windows
detection:
    selection:
        TargetFilename|contains:
            - '\Start Menu\Programs\Startup\'
            - '\Start Menu\Programs\Startup\'
    condition: selection
falsepositives:
    - Legitimate software adding startup entries
level: medium

---

title: Image File Execution Options Injection
id: b8c9d0e1-f2a3-4567-1234-890123456789
status: stable
description: Detects IFEO debugger persistence technique
references:
    - https://attack.mitre.org/techniques/T1546/012/
author: SOC Analyst Home Lab
date: 2024/01/01
tags:
    - attack.persistence
    - attack.t1546.012
logsource:
    category: registry_set
    product: windows
detection:
    selection:
        TargetObject|contains:
            - '\Image File Execution Options\'
        TargetObject|endswith:
            - '\Debugger'
            - '\GlobalFlag'
    condition: selection
falsepositives:
    - Legitimate debugging configurations
level: high

---

title: DLL Search Order Hijacking
id: c9d0e1f2-a3b4-5678-2345-901234567890
status: stable
description: Detects DLL creation in Windows directory (potential hijacking)
references:
    - https://attack.mitre.org/techniques/T1574/001/
author: SOC Analyst Home Lab
date: 2024/01/01
tags:
    - attack.persistence
    - attack.defense_evasion
    - attack.t1574.001
logsource:
    category: file_event
    product: windows
detection:
    selection:
        TargetFilename|startswith:
            - 'C:\Windows\'
            - 'C:\Windows\System32\'
        TargetFilename|endswith: '.dll'
    filter:
        Image|contains:
            - '\Windows\System32\msiexec.exe'
            - '\Windows\System32\TrustedInstaller.exe'
            - '\Windows\servicing\'
    condition: selection and not filter
falsepositives:
    - Windows updates
    - Legitimate software installations
level: high

---

title: Winlogon Helper DLL Persistence
id: d0e1f2a3-b4c5-6789-3456-012345678901
status: stable
description: Detects modification of Winlogon registry keys for persistence
references:
    - https://attack.mitre.org/techniques/T1547/004/
author: SOC Analyst Home Lab
date: 2024/01/01
tags:
    - attack.persistence
    - attack.t1547.004
logsource:
    category: registry_set
    product: windows
detection:
    selection:
        TargetObject|contains: '\Microsoft\Windows NT\CurrentVersion\Winlogon'
        TargetObject|endswith:
            - '\Shell'
            - '\Userinit'
            - '\Notify'
    filter:
        Details|contains:
            - 'explorer.exe'
            - 'userinit.exe'
    condition: selection and not filter
falsepositives:
    - Rare legitimate modifications
level: critical
